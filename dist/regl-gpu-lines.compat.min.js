!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n="undefined"!=typeof globalThis?globalThis:n||self).reglLines=t()}(this,(function(){"use strict";function n(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),e.push.apply(e,r)}return e}function t(t){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?n(Object(o),!0).forEach((function(n){e(t,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):n(Object(o)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(o,n))}))}return t}function e(n,t,e){return t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}function r(n,t){return function(n){if(Array.isArray(n))return n}(n)||function(n,t){var e=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null==e)return;var r,o,i=[],a=!0,s=!1;try{for(e=e.call(n);!(a=(r=e.next()).done)&&(i.push(r.value),!t||i.length!==t);a=!0);}catch(n){s=!0,o=n}finally{try{a||null==e.return||e.return()}finally{if(s)throw o}}return i}(n,t)||i(n,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}()}function o(n){return function(n){if(Array.isArray(n))return a(n)}(n)||function(n){if("undefined"!=typeof Symbol&&null!=n[Symbol.iterator]||null!=n["@@iterator"])return Array.from(n)}(n)||i(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}()}function i(n,t){if(n){if("string"==typeof n)return a(n,t);var e=Object.prototype.toString.call(n).slice(8,-1);return"Object"===e&&n.constructor&&(e=n.constructor.name),"Map"===e||"Set"===e?Array.from(n):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?a(n,t):void 0}}function a(n,t){(null==t||t>n.length)&&(t=n.length);for(var e=0,r=new Array(t);e<t;e++)r[e]=n[e];return r}function s(n,t){var e="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!e){if(Array.isArray(n)||(e=i(n))||t&&n&&"number"==typeof n.length){e&&(n=e);var r=0,o=function(){};return{s:o,n:function(){return r>=n.length?{done:!0}:{done:!1,value:n[r++]}},e:function(n){throw n},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}var a,s=!0,c=!1;return{s:function(){e=e.call(n)},n:function(){var n=e.next();return s=n.done,n},e:function(n){c=!0,a=n},f:function(){try{s||null==e.return||e.return()}finally{if(c)throw a}}}}var c={CAP_START:0,CAP_END:1,CAP_SHORT:2},f=c,l=function(n,e,r){var i=r.regl,a=r.meta,s=r.frag,c=r.segmentSpec,l=r.endpointSpec,u=r.indexAttributes,p=r.insertCaps,d=r.debug,v=e?l:c,y=["B","C","D"];e||y.unshift("A");function m(n){return p?e?[n.capResolution,Math.max(n.capResolution,n.joinResolution)]:[Math.max(n.capResolution,n.joinResolution),Math.max(n.capResolution,n.joinResolution)]:e?[n.capResolution,n.joinResolution]:[n.joinResolution,n.joinResolution]}return i({vert:"".concat(a.glsl,"\nconst float CAP_START=").concat(f.CAP_START,".0;const float CAP_END=").concat(f.CAP_END,".0;").concat(v.glsl,"\nattribute float index;").concat(d?"attribute float debugInstanceID;":"","\nuniform vec2 vertexCount,capJoinRes;uniform vec2 resolution,capScale;uniform float miterLimit;").concat(a.orientation||!e?"":"uniform float orientation;","\nvarying vec3 lineCoord;varying float dir;").concat(d?"varying vec2 triStripCoord;":"","\n").concat(d?"varying float instanceID;":"","\nbool isnan(float val){return(val<0.0||0.0<val||val==0.0)?false:true;}bool invalid(vec4 p){return p.w==0.0||isnan(p.x);}const bool isRound=").concat(n?"true":"false",";const float pi=3.141592653589793;void main(){lineCoord=vec3(0);").concat(d?"instanceID=".concat(e?"-1.0":"debugInstanceID",";"):"","\n").concat(d?"triStripCoord=vec2(floor(index/2.0),mod(index,2.0));":"","\n").concat(y.map((function(n){return"vec4 p".concat(n,"=").concat(a.position.generate(n),";")})).join("\n"),"\nif(invalid(pB)||invalid(pC)){gl_Position=vec4(1,1,1,0);return;}float mirrorIndex=2.0*vertexCount.x+3.0;float totalVertexCount=mirrorIndex+2.0+2.0*vertexCount.y;bool isMirrored=index>mirrorIndex;").concat(e?"if(invalid(pD)&& isMirrored){ gl_Position=vec4(0); return; }":"","\nfloat pw=isMirrored?pC.w:pB.w;").concat(y.map((function(n){return"p".concat(n,"=vec4(vec3(p").concat(n,".xy*resolution,p").concat(n,".z)/p").concat(n,".w,1);")})).join("\n"),"\n").concat(e?"vec4 pA=pC;":"","\nfloat mirrorSign=isMirrored?-1.0:1.0;if(isMirrored){vec4 tmp;tmp=pC; pC=pB; pB=tmp;tmp=pD; pD=pA; pA=tmp;}").concat(e?"bool isCap=!isMirrored;":"bool isCap=false;",";if(invalid(pA)){ ").concat(p?"pA=pC; isCap=true;":"pA=2.0*pB-pC;"," }if(invalid(pD)){ ").concat(p?"pD=pB;":"pD=2.0*pC-pB;"," }float width=isMirrored?").concat(a.width.generate("C"),":").concat(a.width.generate("B"),";if(max(abs(pB.z),abs(pC.z))>1.0){gl_Position=vec4(0);return;}vec2 tBC=pC.xy-pB.xy;float lBC=length(tBC);tBC/=lBC;vec2 nBC=vec2(-tBC.y,tBC.x);vec2 tAB=pB.xy-pA.xy;float lAB=length(tAB);if(lAB>0.0)tAB/=lAB;vec2 nAB=vec2(-tAB.y,tAB.x);vec2 tCD=pD.xy-pC.xy;float lCD=length(tCD);if(lCD>0.0)tCD/=lCD;vec2 nCD=vec2(-tCD.y,tCD.x);float cosB=clamp(dot(tAB,tBC),-1.0,1.0);const float tol=1e-4;float dirB=-dot(tBC,nAB);float dirC=dot(tBC,nCD);bool bCollinear=abs(dirB)<tol;bool cCollinear=abs(dirC)<tol;bool bIsHairpin=bCollinear && cosB<0.0;bool cIsHairpin=cCollinear && dot(tBC,tCD)<0.0;dirB=bCollinear?-mirrorSign:sign(dirB);dirC=cCollinear?-mirrorSign:sign(dirC);vec2 miter=bIsHairpin?-tBC:0.5*(nAB+nBC)*dirB;float i=index<=mirrorIndex?index:totalVertexCount-index;float iSeg=i-2.0*(isMirrored?vertexCount.y:vertexCount.x);if(iSeg>1.0 && iSeg<=3.0){iSeg-=2.0;if(dirB*dirC>=0.0)iSeg+=iSeg==0.0?1.0:-1.0;}vec2 xBasis=tBC;vec2 yBasis=nBC*dirB;vec2 xy=vec2(0,1);lineCoord.y=dirB*mirrorSign;if(iSeg<0.0){float m2=dot(miter,miter);float lm=length(miter);float tBCm=dot(tBC,miter);yBasis=miter/lm;bool isBevel=1.0>miterLimit*m2;if(mod(i,2.0)==0.0){if(isRound||isCap){xBasis=dirB*vec2(yBasis.y,-yBasis.x);float cnt=(isCap?capJoinRes.x:capJoinRes.y)*2.0;float theta=-0.5*(acos(cosB)*(min(i,cnt)/cnt)-pi)*(isCap?2.0:1.0);xy=vec2(cos(theta),sin(theta));if(isCap){if(xy.y>0.001)xy*=capScale;lineCoord.xy=xy.yx*lineCoord.y;}} else {yBasis=bIsHairpin?vec2(0):miter;if(!isBevel)xy.y/=m2;}} else {lineCoord.y=0.0;xy=vec2(0);if(!isRound && isBevel && !isCap){xy.y=-1.0+sqrt((1.0+cosB)*0.5);}}} else if(iSeg>0.0){lineCoord.y=-lineCoord.y;float miterExt=0.0;if(cosB>-0.9999){float sinB=tAB.x*tBC.y-tAB.y*tBC.x;miterExt=sinB/(1.0+cosB);}float m=abs(miterExt);m=min(m,min(lBC,lAB)/width);xy=vec2(m,-1);}").concat(e?"float orientation=".concat(a.orientation?a.orientation.generate(""):"mod(orientation,2.0)",";"):"",";").concat(e?"if(orientation==CAP_END)lineCoord.xy=-lineCoord.xy;":"","\nvec2 dP=mat2(xBasis,yBasis)*xy;float dC=dot(dP,tBC)*mirrorSign;float useC=(isMirrored?1.0:0.0)+dC*(width/lBC);lineCoord.z=useC<0.0||useC>1.0?1.0:0.0;").concat(o(a.varyings.values()).map((function(n){return n.generate("useC","B","C")})).join("\n"),"\ngl_Position=pB;gl_Position.xy+=width*dP;gl_Position.xy/=resolution;gl_Position*=pw;}"),frag:s,attributes:t(t({},u),v.attrs),uniforms:{vertexCount:function(n,t){return m(t)},capJoinRes:function(n,t){return[t.capResolution,t.joinResolution]},miterLimit:function(n,t){return t.miterLimit*t.miterLimit},orientation:i.prop("orientation"),capScale:i.prop("capScale")},primitive:"triangle strip",instances:e?function(n,t){return t.splitCaps?t.orientation===f.CAP_START?Math.ceil(t.count/2):Math.floor(t.count/2):t.count}:function(n,t){return t.count-3},count:function(n,t){var e=m(t);return 6+2*(e[0]+e[1])}})};var u={NONE:0,REGULAR:1,EXTENDED:2,PER_INSTANCE:4},p=u,d=function(n){for(var e=[],r=n.split("\n"),o=0;o<r.length;o++)r[o]=r[o].replace(v,(function(n,t){return e.push(b(t)),""}));return t({glsl:r.join("\n").trim()},function(n){var t,e,r,o,i=new Map,a=new Map,c=s(n);try{for(c.s();!(t=c.n()).done;){var f=t.value;"attribute"===f.type?(i.set(f.name,f),f.vertexUsage=p.NONE,f.endpointUsage=p.NONE):"varying"===f.type&&a.set(f.name,f)}}catch(n){c.e(n)}finally{c.f()}var l,u=s(n);try{for(u.s();!(l=u.n()).done;){var d=l.value;if("property"===d.type){switch(d.property){case"width":if(e)throw new Error('Unexpected duplicate pragma for property "'.concat(d.property,'"'));e=d;break;case"position":if(r)throw new Error('Unexpected duplicate pragma for property "'.concat(d.property,'"'));r=d;break;case"orientation":if(o)throw new Error('Unexpected duplicate pragma for property "'.concat(d.property,'"'));o=d;break;default:throw new Error('Invalid pragma property "'.concat(d.property,'"'))}var v,y=s(d.inputs);try{for(y.s();!(v=y.n()).done;){var m=v.value;if(!i.has(m))throw new Error("Missing attribute ".concat(m," of property ").concat(d.property))}}catch(n){y.e(n)}finally{y.f()}}}}catch(n){u.e(n)}finally{u.f()}var g,h=s(n);try{for(h.s();!(g=h.n()).done;){var b=g.value;if(b.inputs){var C,x=s(b.inputs);try{for(x.s();!(C=x.n()).done;){var w=C.value,B=i.get(w);"property"!==b.type&&"varying"!==b.type||("position"===b.property?(B.vertexUsage|=p.EXTENDED,B.endpointUsage|=p.EXTENDED):"orientation"===b.property?B.endpointUsage|=p.PER_INSTANCE:(B.endpointUsage|=p.REGULAR,B.vertexUsage|=p.REGULAR))}}catch(n){x.e(n)}finally{x.f()}}}}catch(n){h.e(n)}finally{h.f()}return{varyings:a,attrs:i,width:e,position:r,orientation:o}}(e))},v=/^\s*#pragma\s+lines\s*:\s*([^;]*);?$/i,y=/^\s*attribute\s+(float|vec2|vec3|vec4)\s+([\w\d_]+)\s*$/i,m=/^\s*(position|width|orientation)\s+=\s+([\w\d_]+)\s*\(([^)]*)\)\s*$/i,g=/^\s*(?:(extrapolate)?)\s*varying\s+(float|vec2|vec3|vec4)\s+([\w\d_]+)\s*=\s*([\w\d_]+)\(([^)]*)\)\s*$/,h={float:1,vec2:2,vec3:3,vec4:4};function b(n){var t;if(t=(n=n.trim()).match(y))return{type:"attribute",dimension:h[t[1]],name:t[2]};if(t=n.match(m)){var e=t[1],r={width:"float",position:"vec4",orientation:"bool"}[e],o=t[2],i=t[3].split(",").map((function(n){return n.trim()})).filter((function(n){return!!n}));return{type:"property",property:e,returnType:r,name:o,inputs:i,generate:function(n,t){return"".concat(o,"(").concat(i.map((function(e){return(t||"")+e+n})).join(","),")")}}}if(t=n.match(g)){var a="extrapolate"===t[1],s=t[2],c=t[3],f=t[4],l=t[5].split(",").map((function(n){return n.trim()})).filter((function(n){return!!n}));return{type:"varying",returnType:s,name:c,getter:f,inputs:l,generate:function(n,t,e){var r=a?n:"clamp(".concat(n,",0.0,1.0)");return"".concat(c,"=").concat(f,"(").concat(l.map((function(n){return"mix(".concat(n+t,",").concat(n+e,",").concat(r,")")})).join(","),");")}}}throw new Error('Unrecognized lines pragma:"'.concat(n,'"'))}var C=[];C[5120]=1,C[5122]=2,C[5124]=4,C[5121]=1,C[5123]=2,C[5125]=4,C[5126]=4;var x=function(n,t,e){var o={};if(!t)return o;var i,a=s(n.attrs);try{for(a.s();!(i=a.n()).done;){var c=r(i.value,2),f=c[0],l=c[1],u=t[f];if(e?l.endpointUsage:l.vertexUsage){var p={buffer:null,dimension:l.dimension,offset:0,type:NaN,stride:NaN,divisor:1,bytesPerElement:NaN};if(!u)throw new Error("Missing buffer for ".concat(e?"endpoint":"vertex"," attribute '").concat(f,"'"));if("buffer"===u._reglType)p.buffer=u,p.type=p.buffer._buffer.dtype;else{if("buffer"!==u.buffer._reglType)throw new Error("Invalid buffer for attribute '".concat(f,"'"));if(p.buffer=u.buffer,A(u,"dimension")&&u.dimension!==p.dimension)throw new Error("Size of attribute(".concat(u.dimension,")does not match dimension specified in shader pragma(").concat(l.dimension,")"));A(u,"offset")&&(p.offset=u.offset),A(u,"type")?p.type=B[u.type]:p.type=p.buffer._buffer.dtype,A(u,"divisor")&&(p.divisor=u.divisor),A(u,"stride")&&(p.stride=u.stride)}p.bytesPerElement=w[p.type],Number.isNaN(p.stride)&&(p.stride=p.bytesPerElement*l.dimension),o[f]=p}}}catch(n){a.e(n)}finally{a.f()}return o},w=C,B={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126};function A(n,t){return Object.prototype.hasOwnProperty.call(n,t)}var E=[];E[1]="float",E[2]="vec2",E[3]="vec3",E[4]="vec4";var S=function(n,t,e){var r=e?["B","C","D"]:["A","B","C","D"],o=[],i={};return n.attrs.forEach((function(n,a){var s=e?n.endpointUsage:n.vertexUsage;if(s){var c=[];if(s&j.PER_INSTANCE&&u(0,""),s&j.REGULAR||s&j.EXTENDED)for(var f=0;f<r.length;f++){var l=r[f];(s&j.EXTENDED||"D"!==l&&"A"!==l)&&u(f,l)}o.push("attribute ".concat(D[n.dimension]," ").concat(c.join(","),";"))}function u(n,r){var o=a+r;if(c.push(o),e){var f=s&j.PER_INSTANCE?1:3;i[o]={buffer:t.prop("buffers.".concat(a,".buffer")),offset:function(t,e){return e.buffers[a].offset+e.buffers[a].stride*((e.orientation!==R.CAP_START&&e.splitCaps?3:0)+n)},stride:function(n,t){return t.buffers[a].stride*f*(t.splitCaps?2:1)},divisor:function(n,t){return t.buffers[a].divisor}}}else i[o]={buffer:t.prop("buffers.".concat(a,".buffer")),offset:function(t,e){return e.buffers[a].offset+e.buffers[a].stride*n},stride:function(n,t){return t.buffers[a].stride},divisor:function(n,t){return t.buffers[a].divisor}}}})),n.varyings.forEach((function(n,t){o.push("varying ".concat(n.returnType," ").concat(t,";"))})),{glsl:o.join("\n"),attrs:i}},j=u,D=E,R=c;var P=l,T=d,N=x,I=S,_=function(n,t,e){return function(r){if(!r)return e;if(-1===t.indexOf(r))throw new Error("Invalid ".concat(n," type. Valid options are:").concat(t.join(","),"."));return r}},O=c,M=H;H.CAP_START=O.CAP_START,H.CAP_END=O.CAP_END;var U=new Set(["count","instances","attributes","elements"]),L=["round","bevel","miter"],k=["round","square","none"],q=[1,1],z=[2,2/Math.sqrt(3)];function H(n){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.vert,i=void 0===r?null:r,a=e.frag,c=void 0===a?null:a,f=e.debug,l=void 0!==f&&f,u=e.insertCaps,p=void 0!==u&&u,d=t({},e),v=0,y=["vert","frag","debug","insertCaps"];v<y.length;v++){var m=y[v];delete d[m]}var g=Object.keys(d),h=0===g.length;if(g.forEach((function(n){if(U.has(n))throw new Error("Invalid parameter '".concat(n,"'. Parameters ").concat(o(U).map((function(n){return"'".concat(n,"'")})).join(",")," may not be forwarded to regl."))})),!i)throw new Error("Missing vertex shader,`vert`");if(!c)throw new Error("Missing fragment shader,`frag`");var b=T(i),C=I(b,n,!1),x=I(b,n,!0),w=n({uniforms:{resolution:function(n){return[n.viewportWidth,n.viewportHeight]}}}),B=h?function(n,t){return t()}:n(d),A={};l&&(A.debugInstanceID={buffer:n.buffer(new Uint16Array(o(Array(16384).keys()))),divisor:1}),A.index={buffer:n.buffer(new Int8Array(o(Array(184).keys()))),divisor:0};var E={regl:n,meta:b,segmentSpec:C,endpointSpec:x,frag:c,indexAttributes:A,debug:l,insertCaps:p},S=P(!1,!1,E),j=P(!0,!1,E),D=P(!1,!0,E),R=P(!0,!0,E),M=_("join",L,"miter"),H=_("cap",k,"square"),X=[],$=[],G=[],J=[];function V(n){B(n,(function(){X.length&&j(X),G.length&&S(G),$.length&&R($),J.length&&D(J),X.length=0,G.length=0,$.length=0,J.length=0}))}return function(n){if(n){var e=Array.isArray(n);e||(n=[n]);var r=h&&!e;w((function(){var e,o=s(n);try{for(o.s();!(e=o.n()).done;){var i=e.value,a=M(i.join),c=H(i.cap),f=void 0===i.capResolution?12:i.capResolution;"square"===c?f=3:"none"===c&&(f=1);var l=1;"round"===a&&(l=void 0===i.joinResolution?8:i.joinResolution);var u="bevel"===a?1:void 0===i.miterLimit?4:i.miterLimit,p={joinResolution:l,capResolution:f,capScale:"square"===c?z:q,capType:c,miterLimit:u};if(i.endpointAttributes&&i.endpointCount){var d=t({buffers:N(b,i.endpointAttributes,!0),count:i.endpointCount},p),v="round"===a?$:J;b.orientation?v.push(t(t({},d),{},{splitCaps:!1})):v.push(t(t({},d),{},{orientation:O.CAP_START,splitCaps:!0}),t(t({},d),{},{orientation:O.CAP_END,splitCaps:!0}))}if(i.vertexAttributes&&i.vertexCount)("round"===a?X:G).push(t({buffers:N(b,i.vertexAttributes,!1),count:i.vertexCount},p));r||V(i)}}catch(n){o.e(n)}finally{o.f()}r&&V(n)}))}}}return M}));