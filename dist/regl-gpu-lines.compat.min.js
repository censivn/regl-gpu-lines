!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n="undefined"!=typeof globalThis?globalThis:n||self).reglLines=e()}(this,(function(){"use strict";function n(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function e(e){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?n(Object(o),!0).forEach((function(n){t(e,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):n(Object(o)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))}))}return e}function t(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function r(n,e){return function(n){if(Array.isArray(n))return n}(n)||function(n,e){var t=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null==t)return;var r,o,i=[],a=!0,s=!1;try{for(t=t.call(n);!(a=(r=t.next()).done)&&(i.push(r.value),!e||i.length!==e);a=!0);}catch(n){s=!0,o=n}finally{try{a||null==t.return||t.return()}finally{if(s)throw o}}return i}(n,e)||i(n,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}()}function o(n){return function(n){if(Array.isArray(n))return a(n)}(n)||function(n){if("undefined"!=typeof Symbol&&null!=n[Symbol.iterator]||null!=n["@@iterator"])return Array.from(n)}(n)||i(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}()}function i(n,e){if(n){if("string"==typeof n)return a(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?a(n,e):void 0}}function a(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=new Array(e);t<e;t++)r[t]=n[t];return r}function s(n,e){var t="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!t){if(Array.isArray(n)||(t=i(n))||e&&n&&"number"==typeof n.length){t&&(n=t);var r=0,o=function(){};return{s:o,n:function(){return r>=n.length?{done:!0}:{done:!1,value:n[r++]}},e:function(n){throw n},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}var a,s=!0,c=!1;return{s:function(){t=t.call(n)},n:function(){var n=t.next();return s=n.done,n},e:function(n){c=!0,a=n},f:function(){try{s||null==t.return||t.return()}finally{if(c)throw a}}}}var c={CAP_START:0,CAP_END:1,CAP_SHORT:2},f=c,u=function(n,t,r,i,a,s,c,u,l,p,d){var v=t?c:s,h=["B","C","D"];t||h.unshift("A");var y=r?t?function(n){return[n.capRes2,Math.max(n.capRes2,n.joinRes2)]}:function(n){return[Math.max(n.capRes2,n.joinRes2),Math.max(n.capRes2,n.joinRes2)]}:t?function(n){return[n.capRes2,n.joinRes2]}:function(n){return[n.joinRes2,n.joinRes2]};return n(e({vert:"".concat(i.glsl,"\nconst float CAP_START=").concat(f.CAP_START,".0;const float CAP_END=").concat(f.CAP_END,".0;").concat(v.glsl,"\nattribute float index;").concat(d?"attribute float debugInstanceID;":"","\nuniform bool _isRound;uniform vec2 _vertCnt2,_capJoinRes2;uniform vec2 _resolution,_capScale;uniform float _miterLimit;").concat(i.orientation||!t?"":"uniform float _orientation;","\nvarying vec3 lineCoord;").concat(d?"varying vec2 triStripCoord;":"","\n").concat(d?"varying float instanceID;":"","\n").concat(d?"varying float vertexIndex;":"","\nbool isnan(float val){return(val<0.0||0.0<val||val==0.0)?false:true;}bool invalid(vec4 p){return p.w==0.0||isnan(p.x);}void main(){const float pi=3.141592653589793;").concat(d?"vertexIndex=index;":"","\nlineCoord=vec3(0);").concat(d?"instanceID=".concat(t?"-1.0":"debugInstanceID",";"):"","\n").concat(d?"triStripCoord=vec2(floor(index/2.0),mod(index,2.0));":"","\n").concat(h.map((function(n){return"vec4 p".concat(n,"=").concat(i.position.generate(n),";")})).join("\n"),"\ngl_Position=pB;bool aInvalid=").concat(t?"false":"invalid(pA)",";bool bInvalid=invalid(pB);bool cInvalid=invalid(pC);bool dInvalid=invalid(pD);vec2 v=_vertCnt2+3.0;float N=dot(v,vec2(1));bool mirror=index>=v.x;").concat(t?"if(dInvalid && mirror)return;":"","\nfloat pw=mirror?pC.w:pB.w;").concat(h.map((function(n){return"p".concat(n,"=vec4(vec3(p").concat(n,".xy*_resolution,p").concat(n,".z)/p").concat(n,".w,1);")})).join("\n"),"\n").concat(t?"vec4 pA=pC;":"","\nif(bInvalid||cInvalid||max(abs(pB.z),abs(pC.z))>1.0)return;if(mirror){vec4 vTmp=pC; pC=pB; pB=vTmp;vTmp=pD; pD=pA; pA=vTmp;bool bTmp=dInvalid; dInvalid=aInvalid; aInvalid=bTmp;}").concat(t?"bool isCap=!mirror;":"".concat(r?"":"const ","bool isCap=false"),";if(aInvalid){ ").concat(r?"pA=pC; isCap=true;":"pA=2.0*pB-pC;"," }if(dInvalid){ ").concat(r?"pD=pB;":"pD=2.0*pC-pB;"," }bool roundOrCap=_isRound||isCap;float width=mirror?").concat(i.width.generate("C"),":").concat(i.width.generate("B"),";vec2 tBC=pC.xy-pB.xy;float lBC=length(tBC);tBC/=lBC;vec2 nBC=vec2(-tBC.y,tBC.x);vec2 tAB=pB.xy-pA.xy;float lAB=length(tAB);if(lAB>0.0)tAB/=lAB;vec2 nAB=vec2(-tAB.y,tAB.x);vec2 tCD=pD.xy-pC.xy;float lCD=length(tCD);if(lCD>0.0)tCD/=lCD;vec2 nCD=vec2(-tCD.y,tCD.x);float cosB=clamp(dot(tAB,tBC),-1.0,1.0);const float tol=1e-4;float mirrorSign=mirror?-1.0:1.0;float dirB=-dot(tBC,nAB);float dirC=dot(tBC,nCD);bool bCollinear=abs(dirB)<tol;bool cCollinear=abs(dirC)<tol;bool bIsHairpin=bCollinear && cosB<0.0;dirB=bCollinear?-mirrorSign:sign(dirB);dirC=cCollinear?-mirrorSign:sign(dirC);vec2 miter=bIsHairpin?-tBC:0.5*(nAB+nBC)*dirB;//Compute our primary \"join index\",that is,the index starting at the very first point of the join.\nfloat i=mirror?N-index:index;float res=(isCap?_capJoinRes2.x:_capJoinRes2.y);i-=max(0.0,(mirror?_vertCnt2.y:_vertCnt2.x)-res);i+=(dirB<0.0?-1.0:0.0);i-=mirror?1.0:0.0;i=max(0.0,i);vec2 xBasis=tBC;vec2 yBasis=nBC*dirB;vec2 xy=vec2(0);lineCoord.y=dirB*mirrorSign;if(i==res+1.0){float m=cosB>-0.9999?(tAB.x*tBC.y-tAB.y*tBC.x)/(1.0+cosB):0.0;xy=vec2(min(abs(m),min(lBC,lAB)/width),-1);lineCoord.y=-lineCoord.y;} else {float m2=dot(miter,miter);float lm=sqrt(m2);yBasis=miter/lm;xBasis=dirB*vec2(yBasis.y,-yBasis.x);bool isBevel=1.0>_miterLimit*m2;if(mod(i,2.0)==0.0){if(roundOrCap||i !=0.0){float theta=-0.5*(acos(cosB)*(clamp(i,0.0,res)/res)-pi)*(isCap?2.0:1.0);xy=vec2(cos(theta),sin(theta));if(isCap){if(xy.y>0.001)xy*=_capScale;lineCoord.xy=xy.yx*lineCoord.y;}} else {yBasis=bIsHairpin?vec2(0):miter;xy.y=isBevel?1.0:1.0/m2;}} else {lineCoord.y=0.0;if(isBevel && !roundOrCap){xy.y=-1.0+sqrt((1.0+cosB)*0.5);}}}").concat(t?"float _orientation=".concat(i.orientation?i.orientation.generate(""):"mod(_orientation,2.0)",";"):"",";").concat(t?"if(_orientation==CAP_END)lineCoord.xy=-lineCoord.xy;":"","\nvec2 dP=mat2(xBasis,yBasis)*xy;float dx=dot(dP,tBC)*mirrorSign;float useC=(mirror?1.0:0.0)+dx*(width/lBC);lineCoord.z=useC<0.0||useC>1.0?1.0:0.0;").concat(o(i.varyings.values()).map((function(n){return n.generate("useC","B","C")})).join("\n"),"\ngl_Position=pB;gl_Position.xy+=width*dP;gl_Position.xy/=_resolution;gl_Position*=pw;").concat(i.postproject?"gl_Position=".concat(i.postproject,"(gl_Position);"):"","\n}"),frag:a,attributes:e(e({},u),v.attrs),uniforms:e(e({},p),{},{_vertCnt2:function(n,e){return y(e)},_capJoinRes2:function(n,e){return[e.capRes2,e.joinRes2]},_miterLimit:function(n,e){return e.miterLimit*e.miterLimit},_orientation:n.prop("orientation"),_capScale:n.prop("capScale"),_isRound:function(n,e){return"round"===e.join},_resolution:function(n,e){return e.viewportSize||[n.viewportWidth,n.viewportHeight]}}),primitive:"triangle strip",instances:t?function(n,e){return e.splitCaps?e.orientation===f.CAP_START?Math.ceil(e.count/2):Math.floor(e.count/2):e.count}:function(n,e){return e.count-3},count:function(n,e){var t=y(e);return 6+(t[0]+t[1])}},l))};var l={NONE:0,REGULAR:1,EXTENDED:2,PER_INSTANCE:4},p=l,d=function(n){for(var t=[],r=n.split("\n"),o=0;o<r.length;o++)r[o]=r[o].replace(v,(function(n,e){return t.push(C(e)),""}));return e({glsl:r.join("\n").trim()},function(n){var e,t,r,o,i,a=new Map,c=new Map,f=s(n);try{for(f.s();!(t=f.n()).done;){var u=t.value;"attribute"===u.type?(a.set(u.name,u),u.vertexUsage=p.NONE,u.endpointUsage=p.NONE):"varying"===u.type?c.set(u.name,u):"postproject"===u.type&&(e=u.name)}}catch(n){f.e(n)}finally{f.f()}var l,d=s(n);try{for(d.s();!(l=d.n()).done;){var v=l.value;if("property"===v.type){switch(v.property){case"width":if(r)throw new Error('Unexpected duplicate pragma for property "'.concat(v.property,'"'));r=v;break;case"position":if(o)throw new Error('Unexpected duplicate pragma for property "'.concat(v.property,'"'));o=v;break;case"orientation":if(i)throw new Error('Unexpected duplicate pragma for property "'.concat(v.property,'"'));i=v;break;default:throw new Error('Invalid pragma property "'.concat(v.property,'"'))}var h,y=s(v.inputs);try{for(y.s();!(h=y.n()).done;){var m=h.value;if(!a.has(m))throw new Error("Missing attribute ".concat(m," of property ").concat(v.property))}}catch(n){y.e(n)}finally{y.f()}}}}catch(n){d.e(n)}finally{d.f()}var b,g=s(n);try{for(g.s();!(b=g.n()).done;){var C=b.value;if(C.inputs){var w,x=s(C.inputs);try{for(x.s();!(w=x.n()).done;){var B=w.value,A=a.get(B);"property"!==C.type&&"varying"!==C.type||("position"===C.property?(A.vertexUsage|=p.EXTENDED,A.endpointUsage|=p.EXTENDED):"orientation"===C.property?A.endpointUsage|=p.PER_INSTANCE:(A.endpointUsage|=p.REGULAR,A.vertexUsage|=p.REGULAR))}}catch(n){x.e(n)}finally{x.f()}}}}catch(n){g.e(n)}finally{g.f()}return{varyings:c,attrs:a,width:r,position:o,orientation:i,postproject:e}}(t))},v=/^\s*#pragma\s+lines\s*:\s*([^;]*);?$/i,h=/^\s*attribute\s+(float|vec2|vec3|vec4)\s+([\w\d_]+)\s*$/i,y=/^\s*(position|width|orientation)\s+=\s+([\w\d_]+)\s*\(([^)]*)\)\s*$/i,m=/^\s*(?:(extrapolate)?)\s*varying\s+(float|vec2|vec3|vec4)\s+([\w\d_]+)\s*=\s*([\w\d_]+)\(([^)]*)\)\s*$/,b=/^\s*postproject\s+=\s+([\w\d_]+)\s*$/i,g={float:1,vec2:2,vec3:3,vec4:4};function C(n){var e;if(e=(n=n.trim()).match(h))return{type:"attribute",dimension:g[e[1]],name:e[2]};if(e=n.match(y)){var t=e[1],r={width:"float",position:"vec4",orientation:"bool"}[t],o=e[2],i=e[3].split(",").map((function(n){return n.trim()})).filter((function(n){return!!n}));return{type:"property",property:t,returnType:r,name:o,inputs:i,generate:function(n,e){return"".concat(o,"(").concat(i.map((function(t){return(e||"")+t+n})).join(","),")")}}}if(e=n.match(m)){var a="extrapolate"===e[1],s=e[2],c=e[3],f=e[4],u=e[5].split(",").map((function(n){return n.trim()})).filter((function(n){return!!n}));return{type:"varying",returnType:s,name:c,getter:f,inputs:u,generate:function(n,e,t){var r=a?n:"clamp(".concat(n,",0.0,1.0)");return"".concat(c,"=").concat(f,"(").concat(u.map((function(n){return"mix(".concat(n+e,",").concat(n+t,",").concat(r,")")})).join(","),");")}}}if(e=n.match(b))return{type:"postproject",name:e[1]};throw new Error('Unrecognized lines pragma:"'.concat(n,'"'))}var w=[];w[5120]=1,w[5122]=2,w[5124]=4,w[5121]=1,w[5123]=2,w[5125]=4,w[5126]=4;var x=function(n,e,t){var o={};if(!e)return o;var i,a=s(n.attrs);try{for(a.s();!(i=a.n()).done;){var c=r(i.value,2),f=c[0],u=c[1],l=e[f];if(t?u.endpointUsage:u.vertexUsage){var p={buffer:null,dimension:u.dimension,offset:0,type:NaN,stride:NaN,divisor:1,bytesPerElement:NaN};if(!l)throw new Error("Missing buffer for ".concat(t?"endpoint":"vertex"," attribute '").concat(f,"'"));if("buffer"===l._reglType)p.buffer=l,p.type=p.buffer._buffer.dtype;else{if("buffer"!==l.buffer._reglType)throw new Error("Invalid buffer for attribute '".concat(f,"'"));if(p.buffer=l.buffer,j(l,"dimension")&&l.dimension!==p.dimension)throw new Error("Size of attribute(".concat(l.dimension,")does not match dimension specified in shader pragma(").concat(u.dimension,")"));j(l,"offset")&&(p.offset=l.offset),j(l,"type")?p.type=A[l.type]:p.type=p.buffer._buffer.dtype,j(l,"divisor")&&(p.divisor=l.divisor),j(l,"stride")&&(p.stride=l.stride)}p.bytesPerElement=B[p.type],Number.isNaN(p.stride)&&(p.stride=p.bytesPerElement*u.dimension),o[f]=p}}}catch(n){a.e(n)}finally{a.f()}return o},B=w,A={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126};function j(n,e){return Object.prototype.hasOwnProperty.call(n,e)}var _=[];_[1]="float",_[2]="vec2",_[3]="vec3",_[4]="vec4";var E=function(n,e,t){var r=t?["B","C","D"]:["A","B","C","D"],o=[],i={};return n.attrs.forEach((function(n,a){var s=t?n.endpointUsage:n.vertexUsage;if(s){var c=[];if(s&D.PER_INSTANCE&&l(0,""),s&D.REGULAR||s&D.EXTENDED)for(var f=0;f<r.length;f++){var u=r[f];(s&D.EXTENDED||"D"!==u&&"A"!==u)&&l(f,u)}o.push("attribute ".concat(I[n.dimension]," ").concat(c.join(","),";"))}function l(n,r){var o=a+r;if(c.push(o),t){var f=s&D.PER_INSTANCE?1:3;i[o]={buffer:e.prop("buffers.".concat(a,".buffer")),offset:function(e,t){return t.buffers[a].offset+t.buffers[a].stride*((t.orientation!==T.CAP_START&&t.splitCaps?3:0)+n)},stride:function(n,e){return e.buffers[a].stride*f*(e.splitCaps?2:1)},divisor:function(n,e){return e.buffers[a].divisor}}}else i[o]={buffer:e.prop("buffers.".concat(a,".buffer")),offset:function(e,t){return t.buffers[a].offset+t.buffers[a].stride*n},stride:function(n,e){return e.buffers[a].stride},divisor:function(n,e){return e.buffers[a].divisor}}}})),n.varyings.forEach((function(n,e){o.push("varying ".concat(n.returnType," ").concat(e,";"))})),{glsl:o.join("\n"),attrs:i}},D=l,I=_,T=c;var R=u,S=d,P=x,N=E,O=function(n,e,t){return function(r){if(!r)return t;if(-1===e.indexOf(r))throw new Error("Invalid ".concat(n," type. Valid options are:").concat(e.join(","),"."));return r}},U=c,k=X;X.CAP_START=U.CAP_START,X.CAP_END=U.CAP_END;var L=new Set(["attributes","elements"]),M=["round","bevel","miter"],z=["round","square","none"],q=[1,1],H=[2,2/Math.sqrt(3)];function $(n,e){return(n?1:0)+(e?2:0)}function X(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.vert,i=void 0===r?null:r,a=t.frag,c=void 0===a?null:a,f=t.debug,u=void 0!==f&&f,l=t.reorder,p=void 0!==l&&l;n._gpuLinesCache||(n._gpuLinesCache={});for(var d=n._gpuLinesCache,v=e({},t),h=t.uniforms||{},y=0,m=["vert","frag","debug","reorder","uniforms"];y<m.length;y++){var b=m[y];delete v[b]}var g=Object.keys(v);if(g.forEach((function(n){if(L.has(n))throw new Error("Invalid parameter '".concat(n,"'. Parameters ").concat(o(L).map((function(n){return"'".concat(n,"'")})).join(",")," may not be forwarded to regl."))})),!i)throw new Error("Missing vertex shader,`vert`");if(!c)throw new Error("Missing fragment shader,`frag`");var C=S(i),w=N(C,n,!1),x=N(C,n,!0),B={};u&&(d.debugInstanceIDBuffer||(d.debugInstanceIDBuffer=n.buffer(new Uint16Array(o(Array(16384).keys())))),B.debugInstanceID={buffer:d.debugInstanceIDBuffer,divisor:1}),d.indexBuffer||(d.indexBuffer=n.buffer(new Uint8Array(o(Array(134).keys())))),B.index={buffer:d.indexBuffer,divisor:0};var A=O("join",M,"miter"),j=O("cap",z,"square"),_=new Map;function E(e){return _.has(e)||_.set(e,R(n,1&e,2&e,C,c,w,x,B,v,h,u)),_.get(e)}var D=[];function I(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];D.push.apply(D,e)}function T(){p&&D.sort((function(n,e){return n.key-e.key}));for(var n=0,e=[];n<D.length;){var t=D[n],r=t.key,o=t.props;for(e.push(o);++n<D.length&&D[n].key===r;)e.push(D[n].props);E(r)(e),e.length=0}D.length=0}return function(n){if(n){Array.isArray(n)||(n=[n]);var t,r=s(n);try{for(r.s();!(t=r.n()).done;){var o=t.value,i=A(o.join),a=j(o.cap),c=void 0===o.capResolution?12:o.capResolution;"square"===a?c=3:"none"===a&&(c=1);var f=1;"round"===i&&(f=void 0===o.joinResolution?8:o.joinResolution),c*=2,f*=2;var u="bevel"===i?1:void 0===o.miterLimit?4:o.miterLimit,l="square"===a?H:q,p=!!o.insertCaps,d={joinRes2:f,capRes2:c,capScale:l,join:i,miterLimit:u,insertCaps:p};if(o.endpointAttributes&&o.endpointCount){var v=e(e({count:o.endpointCount},o),{},{buffers:P(C,o.endpointAttributes,!0)},d),h=$(!0,p);C.orientation?I({key:h,props:e(e({},v),{},{splitCaps:!1})}):I({key:h,props:e(e({},v),{},{orientation:U.CAP_START,splitCaps:!0})},{key:h,props:e(e({},v),{},{orientation:U.CAP_END,splitCaps:!0})})}o.vertexAttributes&&o.vertexCount&&I({key:$(!1,p),props:e(e({count:o.vertexCount},o),{},{buffers:P(C,o.vertexAttributes,!1)},d)}),T()}}catch(n){r.e(n)}finally{r.f()}}}}return k}));