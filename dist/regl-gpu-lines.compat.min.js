!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n="undefined"!=typeof globalThis?globalThis:n||self).reglLines=t()}(this,(function(){"use strict";function n(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),e.push.apply(e,r)}return e}function t(t){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?n(Object(i),!0).forEach((function(n){e(t,n,i[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))}))}return t}function e(n,t,e){return t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}function r(n,t){return function(n){if(Array.isArray(n))return n}(n)||function(n,t){var e=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null==e)return;var r,i,o=[],a=!0,s=!1;try{for(e=e.call(n);!(a=(r=e.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(n){s=!0,i=n}finally{try{a||null==e.return||e.return()}finally{if(s)throw i}}return o}(n,t)||o(n,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}()}function i(n){return function(n){if(Array.isArray(n))return a(n)}(n)||function(n){if("undefined"!=typeof Symbol&&null!=n[Symbol.iterator]||null!=n["@@iterator"])return Array.from(n)}(n)||o(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}()}function o(n,t){if(n){if("string"==typeof n)return a(n,t);var e=Object.prototype.toString.call(n).slice(8,-1);return"Object"===e&&n.constructor&&(e=n.constructor.name),"Map"===e||"Set"===e?Array.from(n):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?a(n,t):void 0}}function a(n,t){(null==t||t>n.length)&&(t=n.length);for(var e=0,r=new Array(t);e<t;e++)r[e]=n[e];return r}function s(n,t){var e="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(!e){if(Array.isArray(n)||(e=o(n))||t&&n&&"number"==typeof n.length){e&&(n=e);var r=0,i=function(){};return{s:i,n:function(){return r>=n.length?{done:!0}:{done:!1,value:n[r++]}},e:function(n){throw n},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable,non-array objects must have a [Symbol.iterator]()method.")}var a,s=!0,c=!1;return{s:function(){e=e.call(n)},n:function(){var n=e.next();return s=n.done,n},e:function(n){c=!0,a=n},f:function(){try{s||null==e.return||e.return()}finally{if(c)throw a}}}}var c={CAP_START:0,CAP_END:1,CAP_SHORT:2},f=c,l=function(n,e,r){var o=r.regl,a=r.meta,s=r.frag,c=r.segmentSpec,l=r.endpointSpec,u=r.indexAttributes,p=r.insertCaps,d=r.debug,v=e?l:c,y=["B","C","D"];e||y.unshift("A");return o({vert:"".concat(a.glsl,"\nconst float CAP_START=").concat(f.CAP_START,".0;const float CAP_END=").concat(f.CAP_END,".0;").concat(v.glsl,"\nattribute float index;").concat(d?"attribute float debugInstanceID;":"","\nuniform vec3 joinRes;uniform vec2 resolution,capScale;uniform float miterLimit;").concat(a.orientation||!e?"":"uniform float orientation;","\nvarying vec3 lineCoord;varying float dir;").concat(d?"varying vec2 triStripCoord;":"","\n").concat(d?"varying float instanceID;":"","\nbool isnan(float val){return(val<0.0||0.0<val||val==0.0)?false:true;}bool invalid(vec4 p){return p.w==0.0||isnan(p.x);}const bool isRound=").concat(n?"true":"false",";const float pi=3.141592653589793;void main(){lineCoord=vec3(0);").concat(d?"instanceID=".concat(e?"-1.0":"debugInstanceID",";"):"","\n").concat(d?"triStripCoord=vec2(floor(index/2.0),mod(index,2.0));":"","\n").concat(y.map((function(n){return"vec4 p".concat(n,"=").concat(a.position.generate(n),";")})).join("\n"),"\nif(invalid(pB)||invalid(pC)").concat(p?"":"".concat(e?"":"||invalid(pA)","||invalid(pD)"),"){gl_Position=vec4(1,1,1,0);return;}bool isMirrored=index>joinRes.x*2.0+3.0;float pw=isMirrored?pC.w:pB.w;").concat(y.map((function(n){return"p".concat(n,"=vec4(vec3(p").concat(n,".xy*resolution,p").concat(n,".z)/p").concat(n,".w,1);")})).join("\n"),"\n").concat(e?"vec4 pA=pC;":"","\nvec2 res=isMirrored?joinRes.yx:joinRes.xy;float mirrorSign=isMirrored?-1.0:1.0;if(isMirrored){vec4 tmp;tmp=pC; pC=pB; pB=tmp;tmp=pD; pD=pA; pA=tmp;}").concat(e?"bool isCap=!isMirrored;":"bool isCap=false;",";if(invalid(pA)){ pA=pC; isCap=true; }if(invalid(pD)){ pD=pB; }float width=isMirrored?").concat(a.width.generate("C"),":").concat(a.width.generate("B"),";if(max(abs(pB.z),abs(pC.z))>1.0){gl_Position=vec4(1,1,1,0);return;}vec2 tBC=pC.xy-pB.xy;float lBC=length(tBC);tBC/=lBC;vec2 nBC=vec2(-tBC.y,tBC.x);vec2 tAB=pB.xy-pA.xy;float lAB=length(tAB);if(lAB>0.0)tAB/=lAB;vec2 nAB=vec2(-tAB.y,tAB.x);vec2 tCD=pD.xy-pC.xy;float lCD=length(tCD);if(lCD>0.0)tCD/=lCD;vec2 nCD=vec2(-tCD.y,tCD.x);float cosB=clamp(dot(tAB,tBC),-1.0,1.0);const float tol=1e-4;float dirB=-dot(tBC,nAB);float dirC=dot(tBC,nCD);bool bCollinear=abs(dirB)<tol;bool cCollinear=abs(dirC)<tol;bool bIsHairpin=bCollinear && cosB<0.0;bool cIsHairpin=cCollinear && dot(tBC,tCD)<0.0;dirB=bCollinear?-mirrorSign:sign(dirB);dirC=cCollinear?-mirrorSign:sign(dirC);vec2 miter=bIsHairpin?-tBC:0.5*(nAB+nBC)*dirB;float i=index<2.0*joinRes.x+4.0?index:2.0*(res.x+res.y)+5.0-index;float iSeg=i-2.0*res.x;if(iSeg>1.0 && iSeg<=3.0){iSeg-=2.0;if(dirB*dirC>=0.0)iSeg+=iSeg==0.0?1.0:-1.0;}vec2 xBasis=tBC;vec2 yBasis=nBC*dirB;vec2 xy=vec2(0,1);lineCoord.y=dirB*mirrorSign;if(iSeg<0.0){float m2=dot(miter,miter);float lm=length(miter);float tBCm=dot(tBC,miter);yBasis=miter/lm;bool isBevel=1.0>miterLimit*m2;if(mod(i,2.0)==0.0){if(isRound||isCap){xBasis=dirB*vec2(yBasis.y,-yBasis.x);float divisor=").concat(e?"res.x":"min(res.x,isCap?joinRes.z:res.x)","*2.0;float theta=-0.5*(acos(cosB)*(min(i,divisor)/divisor)-pi)*(isCap?2.0:1.0);xy=vec2(cos(theta),sin(theta));if(isCap){if(xy.y>0.5)xy*=capScale;lineCoord.xy=xy.yx*lineCoord.y;}} else {yBasis=bIsHairpin?vec2(0):miter;if(!isBevel)xy.y/=m2;}} else {lineCoord.y=0.0;xy=vec2(0);if(!isRound && isBevel && !isCap){xy.y=-1.0+sqrt((1.0+cosB)*0.5);}}} else if(iSeg>0.0){lineCoord.y=-lineCoord.y;float miterExt=0.0;if(cosB>-0.9999){float sinB=tAB.x*tBC.y-tAB.y*tBC.x;miterExt=sinB/(1.0+cosB);}float m=abs(miterExt);m=min(m,min(lBC,lAB)/width);xy=vec2(m,-1);}").concat(e?"float orientation=".concat(a.orientation?a.orientation.generate(""):"mod(orientation,2.0)",";"):"",";").concat(e?"if(orientation==CAP_END)lineCoord.xy=-lineCoord.xy;":"","\nvec2 dP=mat2(xBasis,yBasis)*xy;float dC=dot(dP,tBC)*mirrorSign;float useC=(isMirrored?1.0:0.0)+dC*(width/lBC);lineCoord.z=useC<0.0||useC>1.0?1.0:0.0;").concat(i(a.varyings.values()).map((function(n){return n.generate("useC","B","C")})).join("\n"),"\ngl_Position=pB;gl_Position.xy+=width*dP;gl_Position.xy/=resolution;gl_Position*=pw;}"),frag:s,attributes:t(t({},u),v.attrs),uniforms:{joinRes:function(n,t){return[e?t.capResolution:t.joinResolution,t.joinResolution,"square"===t.capType?t.capResolution:"none"===t.capType?0:t.joinResolution]},miterLimit:function(n,t){return t.miterLimit*t.miterLimit},orientation:o.prop("orientation"),capScale:o.prop("capScale")},primitive:"triangle strip",instances:e?function(n,t){return t.splitCaps?t.orientation===f.CAP_START?Math.ceil(t.count/2):Math.floor(t.count/2):t.count}:function(n,t){return t.count-3},count:n?function(n,t){return 6+2*(t.joinResolution+(e?t.capResolution:t.joinResolution))}:function(n,t){return 6+2*(1+(e?t.capResolution:1))+10}})};var u={NONE:0,REGULAR:1,EXTENDED:2,PER_INSTANCE:4},p=u,d=function(n){for(var e=[],r=n.split("\n"),i=0;i<r.length;i++)r[i]=r[i].replace(v,(function(n,t){return e.push(h(t)),""}));return t({glsl:r.join("\n").trim()},function(n){var t,e,r,i,o=new Map,a=new Map,c=s(n);try{for(c.s();!(t=c.n()).done;){var f=t.value;"attribute"===f.type?(o.set(f.name,f),f.vertexUsage=p.NONE,f.endpointUsage=p.NONE):"varying"===f.type&&a.set(f.name,f)}}catch(n){c.e(n)}finally{c.f()}var l,u=s(n);try{for(u.s();!(l=u.n()).done;){var d=l.value;if("property"===d.type){switch(d.property){case"width":if(e)throw new Error('Unexpected duplicate pragma for property "'.concat(d.property,'"'));e=d;break;case"position":if(r)throw new Error('Unexpected duplicate pragma for property "'.concat(d.property,'"'));r=d;break;case"orientation":if(i)throw new Error('Unexpected duplicate pragma for property "'.concat(d.property,'"'));i=d;break;default:throw new Error('Invalid pragma property "'.concat(d.property,'"'))}var v,y=s(d.inputs);try{for(y.s();!(v=y.n()).done;){var m=v.value;if(!o.has(m))throw new Error("Missing attribute ".concat(m," of property ").concat(d.property))}}catch(n){y.e(n)}finally{y.f()}}}}catch(n){u.e(n)}finally{u.f()}var g,b=s(n);try{for(b.s();!(g=b.n()).done;){var h=g.value;if(h.inputs){var C,w=s(h.inputs);try{for(w.s();!(C=w.n()).done;){var x=C.value,B=o.get(x);"property"!==h.type&&"varying"!==h.type||("position"===h.property?(B.vertexUsage|=p.EXTENDED,B.endpointUsage|=p.EXTENDED):"orientation"===h.property?B.endpointUsage|=p.PER_INSTANCE:(B.endpointUsage|=p.REGULAR,B.vertexUsage|=p.REGULAR))}}catch(n){w.e(n)}finally{w.f()}}}}catch(n){b.e(n)}finally{b.f()}return{varyings:a,attrs:o,width:e,position:r,orientation:i}}(e))},v=/^\s*#pragma\s+lines\s*:\s*([^;]*);?$/i,y=/^\s*attribute\s+(float|vec2|vec3|vec4)\s+([\w\d_]+)\s*$/i,m=/^\s*(position|width|orientation)\s+=\s+([\w\d_]+)\s*\(([^)]*)\)\s*$/i,g=/^\s*(?:(extrapolate)?)\s*varying\s+(float|vec2|vec3|vec4)\s+([\w\d_]+)\s*=\s*([\w\d_]+)\(([^)]*)\)\s*$/,b={float:1,vec2:2,vec3:3,vec4:4};function h(n){var t;if(t=(n=n.trim()).match(y))return{type:"attribute",dimension:b[t[1]],name:t[2]};if(t=n.match(m)){var e=t[1],r={width:"float",position:"vec4",orientation:"bool"}[e],i=t[2],o=t[3].split(",").map((function(n){return n.trim()})).filter((function(n){return!!n}));return{type:"property",property:e,returnType:r,name:i,inputs:o,generate:function(n,t){return"".concat(i,"(").concat(o.map((function(e){return(t||"")+e+n})).join(","),")")}}}if(t=n.match(g)){var a="extrapolate"===t[1],s=t[2],c=t[3],f=t[4],l=t[5].split(",").map((function(n){return n.trim()})).filter((function(n){return!!n}));return{type:"varying",returnType:s,name:c,getter:f,inputs:l,generate:function(n,t,e){var r=a?n:"clamp(".concat(n,",0.0,1.0)");return"".concat(c,"=").concat(f,"(").concat(l.map((function(n){return"mix(".concat(n+t,",").concat(n+e,",").concat(r,")")})).join(","),");")}}}throw new Error('Unrecognized lines pragma:"'.concat(n,'"'))}var C=[];C[5120]=1,C[5122]=2,C[5124]=4,C[5121]=1,C[5123]=2,C[5125]=4,C[5126]=4;var w=function(n,t,e){var i={};if(!t)return i;var o,a=s(n.attrs);try{for(a.s();!(o=a.n()).done;){var c=r(o.value,2),f=c[0],l=c[1],u=t[f];if(e?l.endpointUsage:l.vertexUsage){var p={buffer:null,dimension:l.dimension,offset:0,type:NaN,stride:NaN,divisor:1,bytesPerElement:NaN};if(!u)throw new Error("Missing buffer for ".concat(e?"endpoint":"vertex"," attribute '").concat(f,"'"));if("buffer"===u._reglType)p.buffer=u,p.type=p.buffer._buffer.dtype;else{if("buffer"!==u.buffer._reglType)throw new Error("Invalid buffer for attribute '".concat(f,"'"));if(p.buffer=u.buffer,A(u,"dimension")&&u.dimension!==p.dimension)throw new Error("Size of attribute(".concat(u.dimension,")does not match dimension specified in shader pragma(").concat(l.dimension,")"));A(u,"offset")&&(p.offset=u.offset),A(u,"type")?p.type=B[u.type]:p.type=p.buffer._buffer.dtype,A(u,"divisor")&&(p.divisor=u.divisor),A(u,"stride")&&(p.stride=u.stride)}p.bytesPerElement=x[p.type],Number.isNaN(p.stride)&&(p.stride=p.bytesPerElement*l.dimension),i[f]=p}}}catch(n){a.e(n)}finally{a.f()}return i},x=C,B={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126};function A(n,t){return Object.prototype.hasOwnProperty.call(n,t)}var E=[];E[1]="float",E[2]="vec2",E[3]="vec3",E[4]="vec4";var j=function(n,t,e){var r=e?["B","C","D"]:["A","B","C","D"],i=[],o={};return n.attrs.forEach((function(n,a){var s=e?n.endpointUsage:n.vertexUsage;if(s){var c=[];if(s&S.PER_INSTANCE&&u(0,""),s&S.REGULAR||s&S.EXTENDED)for(var f=0;f<r.length;f++){var l=r[f];(s&S.EXTENDED||"D"!==l&&"A"!==l)&&u(f,l)}i.push("attribute ".concat(D[n.dimension]," ").concat(c.join(","),";"))}function u(n,r){var i=a+r;if(c.push(i),e){var f=s&S.PER_INSTANCE?1:3;o[i]={buffer:t.prop("buffers.".concat(a,".buffer")),offset:function(t,e){return e.buffers[a].offset+e.buffers[a].stride*((e.orientation!==R.CAP_START&&e.splitCaps?3:0)+n)},stride:function(n,t){return t.buffers[a].stride*f*(t.splitCaps?2:1)},divisor:function(n,t){return t.buffers[a].divisor}}}else o[i]={buffer:t.prop("buffers.".concat(a,".buffer")),offset:function(t,e){return e.buffers[a].offset+e.buffers[a].stride*n},stride:function(n,t){return t.buffers[a].stride},divisor:function(n,t){return t.buffers[a].divisor}}}})),n.varyings.forEach((function(n,t){i.push("varying ".concat(n.returnType," ").concat(t,";"))})),{glsl:i.join("\n"),attrs:o}},S=u,D=E,R=c;var T=l,P=d,N=w,_=j,I=function(n,t,e){return function(r){if(!r)return e;if(-1===t.indexOf(r))throw new Error("Invalid ".concat(n," type. Valid options are:").concat(t.join(","),"."));return r}},O=c,U=H;H.CAP_START=O.CAP_START,H.CAP_END=O.CAP_END;var M=new Set(["count","instances","attributes","elements"]),L=["round","bevel","miter"],k=["round","square","none"],q=[1,1],z=[2,2/Math.sqrt(3)];function H(n){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.vert,o=void 0===r?null:r,a=e.frag,c=void 0===a?null:a,f=e.debug,l=void 0!==f&&f,u=e.insertCaps,p=void 0!==u&&u,d=t({},e),v=0,y=["vert","frag","debug","insertCaps"];v<y.length;v++){var m=y[v];delete d[m]}var g=Object.keys(d),b=0===g.length;if(g.forEach((function(n){if(M.has(n))throw new Error("Invalid parameter '".concat(n,"'. Parameters ").concat(i(M).map((function(n){return"'".concat(n,"'")})).join(",")," may not be forwarded to regl."))})),!o)throw new Error("Missing vertex shader,`vert`");if(!c)throw new Error("Missing fragment shader,`frag`");var h=P(o),C=_(h,n,!1),w=_(h,n,!0),x=n({uniforms:{resolution:function(n){return[n.viewportWidth,n.viewportHeight]}}}),B=b?function(n,t){return t()}:n(d),A={};l&&(A.debugInstanceID={buffer:n.buffer(new Uint16Array(i(Array(16384).keys()))),divisor:1}),A.index={buffer:n.buffer(new Int8Array(i(Array(184).keys()))),divisor:0};var E={regl:n,meta:h,segmentSpec:C,endpointSpec:w,frag:c,indexAttributes:A,debug:l,insertCaps:p},j=T(!1,!1,E),S=T(!0,!1,E),D=T(!1,!0,E),R=T(!0,!0,E),U=I("join",L,"miter"),H=I("cap",k,"square"),X=[],$=[],G=[],W=[];function F(n){B(n,(function(){X.length&&S(X),G.length&&j(G),$.length&&R($),W.length&&D(W),X.length=0,G.length=0,$.length=0,W.length=0}))}return function(n){if(n){var e=Array.isArray(n);e||(n=[n]);var r=b&&!e;x((function(){var e,i=s(n);try{for(i.s();!(e=i.n()).done;){var o=e.value,a=U(o.join),c=H(o.cap),f=void 0===o.capResolution?12:o.capResolution;"square"===c?f=3:"none"===c&&(f=1);var l=1;"round"===a&&(l=void 0===o.joinResolution?8:o.joinResolution);var u="bevel"===a?1:void 0===o.miterLimit?4:o.miterLimit,p={joinResolution:l,capResolution:f,capScale:"square"===c?z:q,capType:c,miterLimit:u};if(o.endpointAttributes&&o.endpointCount){var d=t({buffers:N(h,o.endpointAttributes,!0),count:o.endpointCount},p),v="round"===a?$:W;h.orientation?v.push(t(t({},d),{},{splitCaps:!1})):v.push(t(t({},d),{},{orientation:O.CAP_START,splitCaps:!0}),t(t({},d),{},{orientation:O.CAP_END,splitCaps:!0}))}if(o.vertexAttributes&&o.vertexCount)("round"===a?X:G).push(t({buffers:N(h,o.vertexAttributes,!1),count:o.vertexCount},p));r||F(o)}}catch(n){i.e(n)}finally{i.f()}r&&F(n)}))}}}return U}));